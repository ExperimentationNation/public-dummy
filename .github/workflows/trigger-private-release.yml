name: Trigger Private Repo Release

on:
  release:
    types: [published]

jobs:
  dispatch-to-private-repo:
    runs-on: ubuntu-latest

    steps:
      - name: Create app JWT
        id: jwt
        run: |
          cat > app.json <<'EOF'
          {
            "appId": ${APP_ID},
            "privateKey": "${APP_KEY}"
          }
          EOF
          npm install -g @octokit/auth-app jq
          JWT=$(node -e "const { auth } = require('@octokit/auth-app'); (async () => { const { token } = await auth({ appId: process.env.APP_ID, privateKey: process.env.APP_KEY }); console.log(token); })();")
          echo "jwt=${JWT}" >> $GITHUB_OUTPUT
        env:
          APP_ID: ${{ secrets.XNAT_GITHUB_APP_ID }}
          APP_KEY: ${{ secrets.XNAT_GITHUB_APP_PRIVATE_KEY }}

      - name: List app installations (confirm org vs user)
        run: |
          curl -sS -H "Authorization: Bearer ${{ steps.jwt.outputs.jwt }}" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/app/installations | jq '.[] | {id, account: .account.login}'
        # Note the installation id where account.login == "ExperimentationNation"

      - name: Mint installation token for the org installation
        # Replace <ORG_INSTALLATION_ID> with the id from the previous step
        run: |
          INSTALLATION_ID=<ORG_INSTALLATION_ID>
          curl -sS -X POST \
            -H "Authorization: Bearer ${{ steps.jwt.outputs.jwt }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/app/installations/${INSTALLATION_ID}/access_tokens > token.json
          cat token.json
          TOKEN=$(jq -r '.token' token.json)
          echo "token=${TOKEN}" >> $GITHUB_OUTPUT
        id: inst

      - name: Inspect accepted permissions on target repo
        run: |
          curl -i \
            -H "Authorization: Bearer ${{ steps.inst.outputs.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/ExperimentationNation/devops-experiments

            
      - name: Get app token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.XNAT_GITHUB_APP_ID }}
          private-key: ${{ secrets.XNAT_GITHUB_APP_PRIVATE_KEY }}
          permission-metadata: read
          permission-contents: read
          permission-actions: write
          owner: ExperimentationNation
 #         repositories: |
 #           public-dummy
 #           devops-experiments

      - name: Inspect the token accepted permissions header on a repo-scoped request
        run: |
          curl -i \
            -H "Authorization: Bearer ${{ steps.app-token.outputs.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/ExperimentationNation/devops-experiments

      - name: Debug - list repos visible to installation token
        run: |
          curl -sS \
            -H "Authorization: Bearer ${{ steps.app-token.outputs.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/installation/repositories | jq -r '.repositories[].full_name'

      - name: Token type sanity check
        run: |
          curl -i -H "Authorization: Bearer ${{ steps.app-token.outputs.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/installation/repositories

      - name: Direct repository_dispatch via curl (diagnostic)
        run: |
          set -euxo pipefail
          curl -i -X POST \
            -H "Authorization: Bearer ${{ steps.app-token.outputs.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/ExperimentationNation/devops-experiments/dispatches \
            -d '{"event_type":"kick-off-private-release","client_payload":{"release_tag":"'"${{ github.event.release.tag_name }}"'","public_repo":"'"${{ github.repository }}"'"}}'
          
      - name: Send repository dispatch to private repo
        uses: peter-evans/repository-dispatch@v3
        with:
          #token: ${{ secrets.CLASSIC_PAT_GITHUB }}
          token: ${{ steps.app-token.outputs.token }}
          repository: ExperimentationNation/devops-experiments
          event-type: kick-off-private-release
          client-payload: |
            {
              "release_tag": "${{ github.event.release.tag_name }}",
              "public_repo": "${{ github.repository }}"
            }
